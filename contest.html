<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Contest1</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
    }
    #timer {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { color: #3f51b5; }
    .question {
      margin-bottom: 20px;
      text-align: left;
    }
    textarea {
      width: 100%;
      height: 70px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
      font-size: 1rem;
    }
    button {
      background-color: #3f51b5;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #303f9f;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
<header>Math Contest</header>

<div class="container">
  <div id="timer">Time Remaining: 45:00</div>
  <h2>Part 1: Short Questions (15)</h2>
  <div id="questions"></div>
  <button id="submitBtn">Submit Answers</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA26i_VumRnCZxe1bfDBWXb563ly_w5mn0",
  authDomain: "math-contest-63f0d.firebaseapp.com",
  projectId: "math-contest-63f0d",
  storageBucket: "math-contest-63f0d.firebasestorage.app",
  messagingSenderId: "387688141725",
  appId: "1:387688141725:web:d9742d49e6a49a6bbb5574",
  databaseURL: "https://math-contest-63f0d-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Answer keys
const shortKey = ["420","5","7/9","80","16","cot^3","1/3","393","ans9","1/2","2","ans12","ans13","ans14","ans15"];
const proofKey = ["proof1","proof2","proof3","proof4","proof5"];

let totalSeconds = 45 * 60; // 45 minutes
let currentSection = "short";
let userEmail = null;
const timerElement = document.getElementById("timer");
const submitBtn = document.getElementById("submitBtn");
const questionsContainer = document.getElementById("questions");

// Object to store short answers
const shortAnswers = {};
const proofAnswers = {};

const shortQuestions = ["How many arrangements of the following books can be made in a line: 2 spanish books, 3 english books, 1 history book, and 2 science books such that the history book is on one of the ends of the line. (Assume the same type of books are identical)
"];
const proofQuestions = [];

// Load user
onAuthStateChanged(auth, (user) => {
  if (user) {
    userEmail = user.email.replace(/\./g, "_");
  } else {
    window.location.href = "index.html";
  }
});

// Render 15 short-answer questions
for (let i = 1; i <= 15; i++) {
  const qDiv = document.createElement("div");
  qDiv.classList.add("question");
  qDiv.innerHTML = `<label>Question ${i}: ${shortQuestions[0]}</label><br><textarea id="q${i}" placeholder="Enter your answer here..."></textarea>`;
  questionsContainer.appendChild(qDiv);

  // Track answers in JS object
  const textarea = qDiv.querySelector("textarea");
  textarea.addEventListener("input", (e) => {
    shortAnswers[`q${i}`] = e.target.value.trim();
  });
}

// Timer function
const timer = setInterval(() => {
  totalSeconds--;
  const mins = Math.floor(totalSeconds / 60);
  const secs = totalSeconds % 60;
  timerElement.textContent = `Time Remaining: ${mins}:${secs < 10 ? "0" : ""}${secs}`;
  if (totalSeconds <= 0) {
    clearInterval(timer);
    handleAutoSubmit();
  }
}, 1000);

function handleAutoSubmit() {
  if (currentSection === "short") moveToProofs();
  else submitContest();
}

submitBtn.addEventListener("click", () => {
  if (currentSection === "short") moveToProofs();
  else submitContest();
});

// Move to proofs
function moveToProofs() {
  currentSection = "proofs";
  totalSeconds += 15 * 60; // add 15 minutes

  // Lock short answers
  document.querySelectorAll("textarea").forEach(el => el.readOnly = true);

  // Render proofs
  questionsContainer.innerHTML = "<h2>Part 2: Proof Questions (5)</h2>";
  for (let i = 1; i <= 5; i++) {
    const pDiv = document.createElement("div");
    pDiv.classList.add("question");
    pDiv.innerHTML = `<label>Proof ${i}:</label><br><textarea id="p${i}" placeholder="Enter your proof here..."></textarea>`;
    questionsContainer.appendChild(pDiv);

    // Track proof answers
    const textarea = pDiv.querySelector("textarea");
    textarea.addEventListener("input", (e) => {
      proofAnswers[`p${i}`] = e.target.value.trim();
    });
  }

  submitBtn.textContent = "Submit Final Answers";
}

// Submission and scoring
async function submitContest() {
  clearInterval(timer);
  let score = 0;

  // Grade short answers
  for (let i = 1; i <= 15; i++) {
    const ans = (shortAnswers[`q${i}`] || "").toLowerCase();
    if (ans === shortKey[i-1].toLowerCase()) score += 1;
  }

  // Grade proofs
  for (let i = 1; i <= 5; i++) {
    const ans = (proofAnswers[`p${i}`] || "").toLowerCase();
    if (ans === proofKey[i-1].toLowerCase()) score += 2;
  }

  if (!userEmail) {
    alert("Error: User not logged in properly.");
    return;
  }

  try {
    const userRef = ref(db, "users/" + userEmail);
    const snap = await get(userRef);
    let currentScore = snap.exists() && snap.val().score ? snap.val().score : 0;
    await update(userRef, { score: currentScore + score });

    alert(`Contest submitted!\nYour score: ${score} points`);
    window.location.href = "home.html";
  } catch (err) {
    alert("Error updating score: " + err.message);
  }
}
</script>
</body>
</html>
