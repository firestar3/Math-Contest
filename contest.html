<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Contest4</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
    }
    #timer {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { color: #3f51b5; }
    .question {
      margin-bottom: 20px;
      text-align: left;
    }
    textarea {
      width: 100%;
      height: 70px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
      font-size: 1rem;
    }
    button {
      background-color: #3f51b5;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #303f9f;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
<header>Math Contest</header>

<div class="container">
  <div id="timer">Time Remaining: 45:00</div>
  <h2 id="sectionTitle">Part 1: Short Questions (15)</h2>
  <div id="questions"></div>
  <button id="submitBtn">Submit Answers</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA26i_VumRnCZxe1bfDBWXb563ly_w5mn0",
  authDomain: "math-contest-63f0d.firebaseapp.com",
  projectId: "math-contest-63f0d",
  storageBucket: "math-contest-63f0d.firebasestorage.app",
  messagingSenderId: "387688141725",
  appId: "1:387688141725:web:d9742d49e6a49a6bbb5574",
  databaseURL: "https://math-contest-63f0d-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- Question banks ---
const shortQuestions = [
  "1. How many arrangements of the following books can be made in a line: 2 Spanish books, 3 English books, 1 history book, and 2 science books such that the history book is on one of the ends of the line. (Assume the same type of books are identical)",
  "2. What is the area of a triangle contained by y = 1, y = -0.5x + 4.5, and y = 2x - 3?",
  "3. Define p as a prime number greater than 11. Solve for the sum of the divisors of 12p in terms of P.",
  "4. Count of odd numbers in [300,900] divisible by 3 and not divisible by 5.",
  "5. The following image is provided with a square and a circle. The distance between one side of the square and one inner part of the circle is shown as length 1. The square and circle also share 3 points of Tangency marked as A, B, and C. Solve for the area of the square. ",
  "6. Simplify the fraction into a singular trigonometric function. (csc - sin) / (sec - cos).",
  "7. Define the function f(x) = (x-1)/(x+1). Find the value of f^2025(2),  where f^n(x) denotes the function f(x) being applied n times.",
  "8. Avi is hosting a special “Quad-elimination” football game with 100 teams. The tournament follows like a normal tournament, except when a team loses, it drops to a lower-level bracket, of which there are 4 total brackets. When a team loses in the lowest bracket, they are eliminated. At the end of the rounds, 4 teams will remain, of which the top bracket will play the bottom bracket, and the 2nd bracket will play the 3rd bracket. The winner of each will then play, and then the tournament will be concluded. How many total games will the tournament last? (Note: All 100 teams start in the top bracket)",
  "9. A coin of diameter ⅓ is tossed onto a unit square with a line going from 2 midpoints on opposite sides. The coin will have no part of it outside of the unit square. What is the probability that the coin does not intersect with the line?",
  "10. Aarav the alligator is climbing stairs. If he can climb 1, 2, or 3 steps at a time, find the number of ways that Aarav can climb 15 stairs.",
  "11. Find the number of remainders when x^100 is divided by 25.",
  "12. If P(x) = x^4 + ax^3 + bx^2 + cx + d, and P(1) = 10, P(2) = 20, and P(3) = 30, find the value of (P(12) + P(-8))/10.",
  "13. Incomplete Problem",
  "14. Quadrilateral ABCD is cyclic. Let O be the center of the circle, and DB be the diameter. The radius of the circle is 5/2. If AB = 4, BC = 7, and AC = 8, find the value of DC. Express your answer as a fraction in the simplest form.",
  "15. In triangle ABC, median AF is present, with F being on BC. Cevian BD is present, with D on AC. Lastly, cevian CE is present, with E on AB. Given that AE = 5, BF = CF = 6, and AD = 7, find the ratio of EB/CD. Express your answer as a fraction in the simplest form."
];

const shortKey = ["420","5","28p+28","80","16","cot^3","1/3","393","1/2","5768","2","X","X","X","X"];
const proofKey = ["X","X","X","X","X"];

const proofPrompts = [
  "Proof 1: Find the largest number that cannot be created with the numbers 7, 9, and 11 and prove it's the largest.",
  "Proof 2: Prove that the difference between a square of an odd number and 1 is always divisible by 8.",
  "Proof 3: Dominoes are placed on top of a regular 8x8 chessboard, where each domino takes up two tiles in a 2x1 tile shape that is rotatable. You are given unlimited dominos to fill the chessboard however 2 corners diagonal from each other are removed. Create a proof that there is no arrangement of dominoes that cover the entire board, without overlap and without any pieces hanging over the edges.",
  "Proof 4: Points A, B, and C are situated in a plane such that angle ABC = 90 degrees. Let D be an arbitrary point on AB, and let E be the foot of the perpendicular from D to AC. Prove that angle DBE = angle DCE.",
  "Proof 5: Incomplete Problem"
];

let totalSeconds = 45 * 60;
let currentSection = "short";
let userEmail = null;
const timerElement = document.getElementById("timer");
const submitBtn = document.getElementById("submitBtn");
const questionsContainer = document.getElementById("questions");
const sectionTitle = document.getElementById("sectionTitle");

const shortAnswers = {};
const proofAnswers = {};

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  userEmail = user.email.replace(/\./g, "_");

  // --- Prevent retake ---
  const userRef = ref(db, "users/" + userEmail);
  const snap = await get(userRef);
  if (snap.exists() && snap.val().hasTakenContest) {
    alert("You have already taken the contest. Redirecting to home.");
    window.location.href = "home.html";
    return;
  }

  renderShortQuestions();
  startTimer();
});

function renderShortQuestions() {
  questionsContainer.innerHTML = "";
  shortQuestions.forEach((q, i) => {
    const qDiv = document.createElement("div");
    qDiv.classList.add("question");
    if (i === 5) {
      qDiv.innerHTML += `<img src="Problem5Image.png" alt="Problem 5 Diagram" style="max-width:100%; border-radius:8px; margin:10px 0;">`;
    }
    qDiv.innerHTML = `<label>${q}</label><br><textarea id="q${i+1}" placeholder="Enter your answer..."></textarea>`;
    questionsContainer.appendChild(qDiv);

    qDiv.querySelector("textarea").addEventListener("input", (e) => {
      shortAnswers[`q${i+1}`] = e.target.value.trim();
    });
  });
}

function startTimer() {
  const timer = setInterval(() => {
    totalSeconds--;
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    timerElement.textContent = `Time Remaining: ${mins}:${secs < 10 ? "0" : ""}${secs}`;
    if (totalSeconds <= 0) {
      clearInterval(timer);
      handleAutoSubmit();
    }
  }, 1000);

  submitBtn.addEventListener("click", () => {
    if (currentSection === "short") moveToProofs();
    else submitContest(timer);
  });
}

function moveToProofs() {
  currentSection = "proofs";
  totalSeconds += 15 * 60;
  sectionTitle.textContent = "Part 2: Proof Questions (5)";
  questionsContainer.innerHTML = "";

  proofPrompts.forEach((p, i) => {
    const pDiv = document.createElement("div");
    pDiv.classList.add("question");
    pDiv.innerHTML = `<label>${p}</label><br><textarea id="p${i+1}" placeholder="Enter your proof..."></textarea>`;
    questionsContainer.appendChild(pDiv);

    pDiv.querySelector("textarea").addEventListener("input", (e) => {
      proofAnswers[`p${i+1}`] = e.target.value.trim();
    });
  });

  submitBtn.textContent = "Submit Final Answers";
}

function handleAutoSubmit() {
  if (currentSection === "short") moveToProofs();
  else submitContest();
}

async function submitContest(timer) {
  clearInterval(timer);
  let score = 0;

  for (let i = 0; i < shortKey.length; i++) {
    if ((shortAnswers[`q${i+1}`] || "").toLowerCase() === shortKey[i].toLowerCase()) score += 1;
  }
  for (let i = 0; i < proofKey.length; i++) {
    if ((proofAnswers[`p${i+1}`] || "").toLowerCase() === proofKey[i].toLowerCase()) score += 2;
  }

  try {
    const userRef = ref(db, "users/" + userEmail);
    await update(userRef, { 
      score: score,
      hasTakenContest: true
    });

    alert(`Contest submitted!\nYour score: ${score} points`);
    window.location.href = "home.html";
  } catch (err) {
    alert("Error updating score: " + err.message);
  }
}
</script>
</body>
</html>
