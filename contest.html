<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Contest</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
    }
    #timer {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { color: #3f51b5; }
    .question {
      margin-bottom: 20px;
      text-align: left;
    }
    textarea {
      width: 100%;
      height: 70px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
      font-size: 1rem;
    }
    button {
      background-color: #3f51b5;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #303f9f;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
<header>Math Contest</header>

<div class="container">
  <div id="timer">Time Remaining: 45:00</div>
  <h2 id="sectionTitle">Part 1: Short Questions (15)</h2>
  <div id="questions"></div>
  <button id="submitBtn">Submit Answers</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA26i_VumRnCZxe1bfDBWXb563ly_w5mn0",
  authDomain: "math-contest-63f0d.firebaseapp.com",
  projectId: "math-contest-63f0d",
  storageBucket: "math-contest-63f0d.firebasestorage.app",
  messagingSenderId: "387688141725",
  appId: "1:387688141725:web:d9742d49e6a49a6bbb5574",
  databaseURL: "https://math-contest-63f0d-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- Question banks ---
const shortQuestions = [
  "1. Simplify: 210 + 210",
  "2. Evaluate: 10 / 2",
  "3. Find the ratio 7:9 as a fraction.",
  "4. What is 8 × 10?",
  "5. Simplify 4².",
  "6. Simplify cot × cot².",
  "7. Find 1/9 + 2/9.",
  "8. Evaluate 400 − 7.",
  "9. What is 13 × 3 − 6?",
  "10. Simplify 1 ÷ 2.",
  "11. Solve for x if 2x = 4.",
  "12. Simplify (2×3)² ÷ 3².",
  "13. Find (4×5) − 6.",
  "14. What is √49?",
  "15. Simplify 2³ − 1."
];

const shortKey = ["420","5","7/9","80","16","cot^3","1/3","393","33","1/2","2","4","14","7","7"];
const proofKey = ["proof1","proof2","proof3","proof4","proof5"];

const proofPrompts = [
  "Proof 1: Prove that the sum of two even numbers is even.",
  "Proof 2: Prove that √2 is irrational.",
  "Proof 3: Show that the sum of the angles in a triangle is 180°.",
  "Proof 4: Prove that if a number is divisible by 4, it is even.",
  "Proof 5: Prove that there are infinitely many prime numbers."
];

let totalSeconds = 45 * 60;
let currentSection = "short";
let userEmail = null;
const timerElement = document.getElementById("timer");
const submitBtn = document.getElementById("submitBtn");
const questionsContainer = document.getElementById("questions");
const sectionTitle = document.getElementById("sectionTitle");

const shortAnswers = {};
const proofAnswers = {};

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  userEmail = user.email.replace(/\./g, "_");

  // --- Prevent retake ---
  const userRef = ref(db, "users/" + userEmail);
  const snap = await get(userRef);
  if (snap.exists() && snap.val().hasTakenContest) {
    alert("You have already taken the contest. Redirecting to home.");
    window.location.href = "home.html";
    return;
  }

  renderShortQuestions();
  startTimer();
});

function renderShortQuestions() {
  questionsContainer.innerHTML = "";
  shortQuestions.forEach((q, i) => {
    const qDiv = document.createElement("div");
    qDiv.classList.add("question");
    qDiv.innerHTML = `<label>${q}</label><br><textarea id="q${i+1}" placeholder="Enter your answer..."></textarea>`;
    questionsContainer.appendChild(qDiv);

    qDiv.querySelector("textarea").addEventListener("input", (e) => {
      shortAnswers[`q${i+1}`] = e.target.value.trim();
    });
  });
}

function startTimer() {
  const timer = setInterval(() => {
    totalSeconds--;
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    timerElement.textContent = `Time Remaining: ${mins}:${secs < 10 ? "0" : ""}${secs}`;
    if (totalSeconds <= 0) {
      clearInterval(timer);
      handleAutoSubmit();
    }
  }, 1000);

  submitBtn.addEventListener("click", () => {
    if (currentSection === "short") moveToProofs();
    else submitContest(timer);
  });
}

function moveToProofs() {
  currentSection = "proofs";
  totalSeconds += 15 * 60;
  sectionTitle.textContent = "Part 2: Proof Questions (5)";
  questionsContainer.innerHTML = "";

  proofPrompts.forEach((p, i) => {
    const pDiv = document.createElement("div");
    pDiv.classList.add("question");
    pDiv.innerHTML = `<label>${p}</label><br><textarea id="p${i+1}" placeholder="Enter your proof..."></textarea>`;
    questionsContainer.appendChild(pDiv);

    pDiv.querySelector("textarea").addEventListener("input", (e) => {
      proofAnswers[`p${i+1}`] = e.target.value.trim();
    });
  });

  submitBtn.textContent = "Submit Final Answers";
}

function handleAutoSubmit() {
  if (currentSection === "short") moveToProofs();
  else submitContest();
}

async function submitContest(timer) {
  clearInterval(timer);
  let score = 0;

  for (let i = 0; i < shortKey.length; i++) {
    if ((shortAnswers[`q${i+1}`] || "").toLowerCase() === shortKey[i].toLowerCase()) score += 1;
  }
  for (let i = 0; i < proofKey.length; i++) {
    if ((proofAnswers[`p${i+1}`] || "").toLowerCase() === proofKey[i].toLowerCase()) score += 2;
  }

  try {
    const userRef = ref(db, "users/" + userEmail);
    await update(userRef, { 
      score: score,
      hasTakenContest: true
    });

    alert(`Contest submitted!\nYour score: ${score} points`);
    window.location.href = "home.html";
  } catch (err) {
    alert("Error updating score: " + err.message);
  }
}
</script>
</body>
</html>
